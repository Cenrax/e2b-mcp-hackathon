"""Dependency vulnerability scanner"""

import re
from typing import Optional
from dataclasses import dataclass
from src.utils.logger import setup_logger

logger = setup_logger(__name__)


@dataclass
class Vulnerability:
    """Vulnerability information"""
    package: str
    current_version: str
    vulnerability_id: str
    severity: str
    description: str
    fixed_version: Optional[str] = None


class DependencyScanner:
    """Scan dependencies for vulnerabilities"""
    
    # Simplified vulnerability database (in production, use real CVE database)
    KNOWN_VULNS = {
        "requests": {
            "2.25.0": {
                "id": "CVE-2023-32681",
                "severity": "medium",
                "description": "Unintended leak of Proxy-Authorization header",
                "fixed": "2.31.0"
            }
        },
        "flask": {
            "1.0.0": {
                "id": "CVE-2023-30861",
                "severity": "high",
                "description": "Cookie parsing vulnerability",
                "fixed": "2.3.2"
            }
        },
        "django": {
            "3.0.0": {
                "id": "CVE-2023-43665",
                "severity": "high",
                "description": "Potential denial-of-service vulnerability",
                "fixed": "4.2.6"
            }
        }
    }
    
    def parse_requirements(self, content: str) -> list[tuple[str, str]]:
        """Parse requirements.txt content"""
        dependencies = []
        
        for line in content.split("\n"):
            line = line.strip()
            if not line or line.startswith("#"):
                continue
            
            # Parse package==version
            match = re.match(r"([a-zA-Z0-9\-_]+)==([0-9\.]+)", line)
            if match:
                package, version = match.groups()
                dependencies.append((package.lower(), version))
        
        logger.info(f"Parsed {len(dependencies)} dependencies")
        return dependencies
    
    def scan_dependencies(self, content: str) -> list[Vulnerability]:
        """Scan dependencies for known vulnerabilities"""
        dependencies = self.parse_requirements(content)
        vulnerabilities = []
        
        for package, version in dependencies:
            if package in self.KNOWN_VULNS:
                if version in self.KNOWN_VULNS[package]:
                    vuln_info = self.KNOWN_VULNS[package][version]
                    vuln = Vulnerability(
                        package=package,
                        current_version=version,
                        vulnerability_id=vuln_info["id"],
                        severity=vuln_info["severity"],
                        description=vuln_info["description"],
                        fixed_version=vuln_info.get("fixed")
                    )
                    vulnerabilities.append(vuln)
                    logger.warning(f"Found vulnerability: {vuln.vulnerability_id} in {package}")
        
        logger.info(f"Found {len(vulnerabilities)} vulnerabilities")
        return vulnerabilities
